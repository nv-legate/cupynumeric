---
on:
  workflow_call:
    inputs:
      platform:
        type: string
        required: true
      ref-sha:
        required: false
        type: string
        default: ''
      target-device:
        type: string
        required: true
      build-type:
        type: string
        required: true
      build-has-tests:
        required: true
        type: boolean
      python-version:
        required: false
        type: string
        default: "3.12"
      refname:
        required: true
        type: string
      default-branch:
        required: true
        type: string
      cuda-version:
        required: false
        type: string

jobs:
  setup-build:
#jrp    if: ${{ !github.event.act }}
    name: Setup build
    runs-on: linux-amd64-cpu4
    outputs:
      runner_type: ${{ steps.set_runner.outputs.runner_type }}
    steps:
      - id: set_runner
        run: |
          if [ "${{ inputs.platform }}" = "linux" ]; then
            if [ "${{ github.repository_owner }}" = "nv-legate" ]; then
              echo "runner_type=linux-amd64-cpu16" >> $GITHUB_OUTPUT
            else
              echo "runner_type=ubuntu-latest" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ inputs.platform }}" = "linux-aarch64" ]; then
            echo "runner_type=linux-arm64-cpu16"  >> $GITHUB_OUTPUT
          elif [ "${{ inputs.platform }}" = "mac" ]; then
            echo "runner_type=macos-latest"  >> $GITHUB_OUTPUT
          fi

  build:
    needs: setup-build
    name: "Build (${{ inputs.platform }}, ${{ inputs.target-device }}, ${{ inputs.build-type }}, Python ${{ inputs.python-version }})"
    uses:
      nv-legate/legate-gh-ci/.github/workflows/gh-build.yml@v1.48
    with:
      build-has-tests: ${{ inputs.build-has-tests }}
      build-mode: ""
      build-type: ${{ inputs.build-type }}
      client-repo: ${{ github.event.repository.name }}
      client-ref: ${{ inputs.ref-sha }}
      legate-gh-ci-tag: "v1.46"
      network: "ucx"
      platform: ${{ inputs.platform }}
      python-version: ${{ inputs.python-version }}
      runs-on: ${{ needs.setup-build.outputs.runner_type }}
      target-device: ${{ inputs.target-device }}
      use-container: ${{ inputs.platform == 'linux' || inputs.platform == 'linux-aarch64' }}
      setup-python-proxy-cache: true
      timeout: ${{ (inputs.platform == 'linux-aarch64' && inputs.target-device == 'gpu') && 120 || 60 }}
      cuda-version: ${{ inputs.cuda-version }}
    secrets: inherit

  setup-test:
    if: inputs.build-has-tests == true
    name: Setup test
    needs:
      - build
    runs-on: linux-amd64-cpu4
    timeout-minutes: 20
    env:
      BUILD_TYPE: ${{ inputs.build-type }}
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          set -xeuo pipefail

          if [ "${{ inputs.target-device }}" = "gpu" ] && [ "${{ inputs.platform }}" = "linux" ]; then
            export MATRICES="
              ci:
                - { runner: 'linux-amd64-gpu-l4-latest-1', test_name: '1 CPU test', test_options: 'test --cpus 1 --debug', proxycache: false}
                - { runner: 'linux-amd64-gpu-l4-latest-1', test_name: '2 CPU test', test_options: 'test --cpus 2 --debug', proxycache: false}
                - { runner: 'linux-amd64-gpu-l4-latest-1', test_name: 'GPU test', test_options: 'test --use cuda --gpus 1 --debug', proxycache: false}
                - { runner: 'linux-amd64-gpu-t4-latest-2', test_name: '2 GPU test', test_options: 'test --use cuda --gpus 2 --debug', proxycache: false}
                - { runner: 'linux-amd64-gpu-l4-latest-1', test_name: 'OpenMP test', test_options: 'test --use openmp --omps 1 --ompthreads 2 --debug', proxycache: false}
                - { runner: 'linux-amd64-gpu-t4-latest-2', test_name: '2 NUMA OpenMPs test', test_options: 'test --use openmp --omps 2 --ompthreads 2 --numamem 2048 --debug', proxycache: false}
                - { runner: 'linux-amd64-gpu-l4-latest-1', test_name: 'Eager execution test', test_options: 'test --use eager --debug', proxycache: false}
              nightly:
                - { runner: 'linux-amd64-gpu-l4-latest-1', test_name: '1 CPU test', test_options: 'test --cpus 1 --debug', proxycache: false}
                - { runner: 'linux-amd64-gpu-l4-latest-1', test_name: '2 CPU test', test_options: 'test --cpus 2 --debug', proxycache: false}
                - { runner: 'linux-amd64-gpu-l4-latest-1', test_name: 'GPU test', test_options: 'test --use cuda --gpus 1 --debug', proxycache: false}
                - { runner: 'linux-amd64-gpu-t4-latest-2', test_name: '2 GPU test', test_options: 'test --use cuda --gpus 2 --debug', proxycache: false}
                - { runner: 'linux-amd64-gpu-l4-latest-1', test_name: 'OpenMP test', test_options: 'test --use openmp --omps 1 --ompthreads 2 --debug', proxycache: false}
                - { runner: 'linux-amd64-gpu-t4-latest-2', test_name: '2 NUMA OpenMPs test', test_options: 'test --use openmp --omps 2 --ompthreads 2 --numamem 2048 --debug', proxycache: false}
                - { runner: 'linux-amd64-gpu-l4-latest-1', test_name: 'Eager execution test', test_options: 'test --use eager --debug', proxycache: false}
            "
          fi
          if [ "${{ inputs.target-device }}" = "cpu" ] && [ "${{ inputs.platform }}" = "linux" ]; then
            export MATRICES="
              ci:
                - { runner: 'linux-amd64-cpu16', test_name: '1 CPU test', test_options: 'test --cpus 1 --debug', proxycache: true}
                - { runner: 'linux-amd64-cpu16', test_name: '2 CPU test', test_options: 'test --cpus 2 --debug', proxycache: true}
                - { runner: 'linux-amd64-cpu16', test_name: 'OpenMP test', test_options: 'test --use openmp --omps 1 --ompthreads 2 --debug', proxycache: true}
                - { runner: 'linux-amd64-cpu16', test_name: '2 NUMA OpenMPs test', test_options: 'test --use openmp --omps 2 --ompthreads 2 --numamem 2048 --debug', proxycache: true}
                - { runner: 'linux-amd64-cpu16', test_name: 'Eager execution test', test_options: 'test --use eager --debug', proxycache: true}
                - { runner: 'linux-amd64-cpu16', test_name: 'mypy', test_options: 'mypy', proxycache: true}
                - { runner: 'linux-amd64-cpu16', test_name: 'Unit tests', test_options: 'unit', proxycache: true}
                - { runner: 'linux-amd64-cpu16', test_name: 'CPP tests', test_options: 'cpp', proxycache: true}
              nightly:
                - { runner: 'linux-amd64-cpu16', test_name: '1 CPU test', test_options: 'test --cpus 1 --debug', proxycache: true}
                - { runner: 'linux-amd64-cpu16', test_name: '2 CPU test', test_options: 'test --cpus 2 --debug', proxycache: true}
                - { runner: 'linux-amd64-cpu16', test_name: 'OpenMP test', test_options: 'test --use openmp --omps 1 --ompthreads 2 --debug', proxycache: true}
                - { runner: 'linux-amd64-cpu16', test_name: '2 NUMA OpenMPs test', test_options: 'test --use openmp --omps 2 --ompthreads 2 --numamem 2048 --debug', proxycache: true}
                - { runner: 'linux-amd64-cpu16', test_name: 'Eager execution test', test_options: 'test --use eager --debug', proxycache: true}
                - { runner: 'linux-amd64-cpu16', test_name: 'mypy', test_options: 'mypy', proxycache: true}
                - { runner: 'linux-amd64-cpu16', test_name: 'Unit tests', test_options: 'unit', proxycache: true}
                - { runner: 'linux-amd64-cpu16', test_name: 'CPP tests', test_options: 'cpp', proxycache: true}
            "
          fi
          # Do not run the tests for ci builds
          if [ "${{ inputs.target-device }}" = "gpu" ] && [ "${{ inputs.platform }}" = "linux-aarch64" ] && [ "${{ inputs.build-type }}" != "ci" ]; then
            export MATRICES="
              ci:
                - { runner: 'linux-arm64-gpu-l4-latest-1', test_name: '1 CPU test', test_options: 'test --cpus 1 --debug', proxycache: false}
                - { runner: 'linux-arm64-gpu-l4-latest-1', test_name: '2 CPU test', test_options: 'test --cpus 2 --debug', proxycache: false}
                - { runner: 'linux-arm64-gpu-l4-latest-1', test_name: 'GPU test', test_options: 'test --use cuda --gpus 1 --debug', proxycache: false}
                - { runner: 'linux-aarch64-2gpu', test_name: '2 GPU test', test_options: 'test --use cuda --gpus 2 --debug', proxycache: false}
                - { runner: 'linux-arm64-gpu-l4-latest-1', test_name: 'OpenMP test', test_options: 'test --use openmp --omps 1 --ompthreads 2 --debug', proxycache: false}
                - { runner: 'linux-aarch64-2gpu', test_name: '2 NUMA OpenMPs test', test_options: 'test --use openmp --omps 2 --ompthreads 2 --numamem 2048 --debug', proxycache: false}
                - { runner: 'linux-arm64-gpu-l4-latest-1', test_name: 'Eager execution test', test_options: 'test --use eager --debug', proxycache: false}
              nightly:
                - { runner: 'linux-arm64-gpu-l4-latest-1', test_name: '1 CPU test', test_options: 'test --cpus 1 --debug', proxycache: false}
                - { runner: 'linux-arm64-gpu-l4-latest-1', test_name: '2 CPU test', test_options: 'test --cpus 2 --debug', proxycache: false}
                - { runner: 'linux-arm64-gpu-l4-latest-1', test_name: 'GPU test', test_options: 'test --use cuda --gpus 1 --debug', proxycache: false}
                - { runner: 'linux-aarch64-2gpu', test_name: '2 GPU test', test_options: 'test --use cuda --gpus 2 --debug', proxycache: false}
                - { runner: 'linux-arm64-gpu-l4-latest-1', test_name: 'OpenMP test', test_options: 'test --use openmp --omps 1 --ompthreads 2 --debug', proxycache: false}
                - { runner: 'linux-aarch64-2gpu', test_name: '2 NUMA OpenMPs test', test_options: 'test --use openmp --omps 2 --ompthreads 2 --numamem 2048 --debug', proxycache: false}
                - { runner: 'linux-arm64-gpu-l4-latest-1', test_name: 'Eager execution test', test_options: 'test --use eager --debug', proxycache: false}
            "
          fi

          if [ "${{ inputs.target-device }}" = "cpu" ] && [ "${{ inputs.platform }}" = "linux-aarch64" ]; then
            export MATRICES="
              ci:
                - { runner: 'linux-arm64-cpu16', test_name: '1 CPU test', test_options: 'test --cpus 1 --debug', proxycache: true}
                - { runner: 'linux-arm64-cpu16', test_name: '2 CPU test', test_options: 'test --cpus 2 --debug', proxycache: true}
                - { runner: 'linux-arm64-cpu16', test_name: 'OpenMP test', test_options: 'test --use openmp --omps 1 --ompthreads 2 --debug', proxycache: true}
                - { runner: 'linux-arm64-cpu16', test_name: '2 NUMA OpenMPs test', test_options: 'test --use openmp --omps 2 --ompthreads 2 --numamem 2048 --debug', proxycache: true}
                - { runner: 'linux-arm64-cpu16', test_name: 'Eager execution test', test_options: 'test --use eager --debug', proxycache: true}
                - { runner: 'linux-arm64-cpu16', test_name: 'mypy', test_options: 'mypy', proxycache: true}
                - { runner: 'linux-arm64-cpu16', test_name: 'Unit tests', test_options: 'unit', proxycache: true}
                - { runner: 'linux-arm64-cpu16', test_name: 'CPP tests', test_options: 'cpp', proxycache: true}
              nightly:
                - { runner: 'linux-arm64-cpu16', test_name: '1 CPU test', test_options: 'test --cpus 1 --debug', proxycache: true}
                - { runner: 'linux-arm64-cpu16', test_name: '2 CPU test', test_options: 'test --cpus 2 --debug', proxycache: true}
                - { runner: 'linux-arm64-cpu16', test_name: 'OpenMP test', test_options: 'test --use openmp --omps 1 --ompthreads 2 --debug', proxycache: true}
                - { runner: 'linux-arm64-cpu16', test_name: '2 NUMA OpenMPs test', test_options: 'test --use openmp --omps 2 --ompthreads 2 --numamem 2048 --debug', proxycache: true}
                - { runner: 'linux-arm64-cpu16', test_name: 'Eager execution test', test_options: 'test --use eager --debug', proxycache: true}
                - { runner: 'linux-arm64-cpu16', test_name: 'mypy', test_options: 'mypy', proxycache: true}
                - { runner: 'linux-arm64-cpu16', test_name: 'Unit tests', test_options: 'unit', proxycache: true}
                - { runner: 'linux-arm64-cpu16', test_name: 'CPP tests', test_options: 'cpp', proxycache: true}
            "
          fi
          # Use the nightly matrix for branch tests
          MATRIX_TYPE="${BUILD_TYPE}"
          if [[ "${MATRIX_TYPE}" == "branch" ]]; then
            MATRIX_TYPE="nightly"
          fi
          export MATRIX_TYPE
          TEST_MATRIX=$(yq -n 'env(MATRICES) | .[strenv(MATRIX_TYPE)]')
          export TEST_MATRIX

          MATRIX="$(
            yq -n -o json 'env(TEST_MATRIX)' | \
            jq -c '{include: .}'
          )"

          echo "matrix=${MATRIX}" | tee --append "${GITHUB_OUTPUT}"

  test:
    needs:
      - setup-test
    name: ${{ matrix.test_name }} ${{ inputs.python-version }} ${{ inputs.cuda-version}}

    strategy:
      fail-fast: false
      matrix: ${{fromJson(needs.setup-test.outputs.matrix)}}

    uses:
      nv-legate/legate-gh-ci/.github/workflows/gh-test-within-container.yml@v1.48
    with:
      build-has-tests: ${{ inputs.build-has-tests }}
      build-mode: ""
      build-type: ${{ inputs.build-type }}
      client-repo: ${{ github.event.repository.name }}
      client-ref: ${{ inputs.ref-sha }}
      has-gpu: ${{ inputs.target-device == 'gpu' }}
      legate-gh-ci-tag: "v1.46"
      name: ${{ matrix.test_name }}
      network: "ucx"
      platform: ${{ inputs.platform }}
      python-version: ${{ inputs.python-version }}
      runs-on: ${{ matrix.runner }}
      target-device: ${{ inputs.target-device }}
      test-options: ${{ matrix.test_options }}
      setup-python-proxy-cache: ${{ matrix.proxycache }}
      enable-core-dumps: false
      timeout: 50
      cuda-version: ${{ inputs.cuda-version }}
    secrets: inherit

  upload:
    needs: test
    # The use of always() below, ensures the step will run even on failure of the tests
    # before if other conditionals are all true.
    if: ${{ always() && github.repository_owner == 'nv-legate' && contains(github.workflow, 'release') && inputs.build-has-tests == false }}
    name: Upload package to Anaconda Server
    uses:
      nv-legate/legate-gh-ci/.github/workflows/gh-upload.yml@v1.48
    with:
      build-has-tests: false
      build-mode: ""
      build-type: ${{ inputs.build-type }}
      client-repo: ${{ github.event.repository.name }}
      client-ref: ${{ inputs.ref-sha }}
      legate-gh-ci-tag: "v1.45"
      name: Upload package to Server
      network: "ucx"
      pkgSubString: "cupynumeric-"
      platform: ${{ inputs.platform }}
      python-version: ${{ inputs.python-version }}
      repos-Root: "cupynumeric"
      target-device: ${{ inputs.target-device }}
      upload-action: upload-package-Anaconda
      refname: ${{ inputs.refname }}
      default-branch: ${{ inputs.default-branch }}
      timeout: 15
      cuda-version: ${{ inputs.cuda-version }}
    secrets: inherit
